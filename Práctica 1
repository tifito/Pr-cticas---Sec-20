/* Cargar el fichero TARJETAS.SQL que contiene números de tarjeta de 2
tipos: visa y mastercard. El fichero está en los recursos de este capítulo
o Debemos devolver el número de tarjeta formateado . El número de
tarjeta está dividido en 4 trozos de 4 números.
o En el caso de VISA lo separamos con un guión “-“
▪ 4057368927695721 → 4057-3689-2769-5721
o En el caso de MASTERCARD lo separamos con barra
▪ 5490322198577839 → 5490-3221-9857-7839
o Si el número de tarjeta no tiene 16 dígitos devolvemos ‘Número
incorrecto’
*/

delimiter //  
drop function if exists dividir_tarjeta//  -- Elimina la función si ya existe

CREATE FUNCTION dividir_tarjeta(num_tarjeta VARCHAR(16), tipo VARCHAR(10))  -- Crea la función con los dos parametros: número y tipo de tarjeta
RETURNS VARCHAR(50)  -- Devuelve un texto formateado con un máximo de 50 caracteres
NO SQL  -- Indica que la función no ejecuta consultas SQL
BEGIN
  DECLARE bloque1 VARCHAR(4);  -- Declara las variables para dividir el número en bloques de 4
  DECLARE bloque2 VARCHAR(4);
  DECLARE bloque3 VARCHAR(4);
  DECLARE bloque4 VARCHAR(4);
  set bloque1=' ';  -- Inicializa los bloques vacíos
  set bloque2=' ';
  set bloque3=' ';
  set bloque4=' ';

  if length(num_tarjeta)<>16 then  -- Verifica que la tarjeta tenga exactamente 16 dígitos
    return 'Número incorrecto';  -- Si no cumple, devuelve este mensaje
  end if;

  if tipo='visa' then  -- Si la tarjeta es de tipo VISA
    SET bloque1 = SUBSTRING(num_tarjeta, 1, 4);   -- Extrae los primeros 4 dígitos
    SET bloque2 = SUBSTRING(num_tarjeta, 5, 4);   -- Extrae del 5 al 8
    SET bloque3 = SUBSTRING(num_tarjeta, 9, 4);   -- Extrae del 9 al 12
    SET bloque4 = SUBSTRING(num_tarjeta, 13, 4);  -- Extrae del 13 al 16
    RETURN CONCAT(bloque1, '-', bloque2, '-', bloque3, '-', bloque4);  -- Une los bloques con guiones
  end if;

  if tipo='mastercard' then  -- Si la tarjeta es MASTERCARD
    SET bloque1 = SUBSTRING(num_tarjeta, 1, 4);
    SET bloque2 = SUBSTRING(num_tarjeta, 5, 4);
    SET bloque3 = SUBSTRING(num_tarjeta, 9, 4);
    SET bloque4 = SUBSTRING(num_tarjeta, 13, 4);
    RETURN CONCAT(bloque1, '/', bloque2, '/', bloque3, '/', bloque4);  -- Une los bloques con barras
  end if;

  return('nada');  -- Si no se cumple ninguna condición, devuelve “nada”
END//

-- Probar la función
select num_tarjeta, tipo, dividir_tarjeta(num_tarjeta, tipo) from tarjetas//  -- Muestra el número original, el tipo y el resultado formateado
